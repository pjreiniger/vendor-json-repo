name: 'Add Vendordep'
description: 'Adds a vendordep to the repository and creates a pull request the upstream repo'

inputs:
  token:
    description: 'GitHub API token'
    required: true
  vendordep_file:
    description: 'Path to the vendordep file to upload'
    required: true
  pr_title:
    description: 'The contents used as the PR title when opening the pull request'
    required: true
  pr_branch:
    description: 'The name of the branch to use when creating the pull request'
    required: true
  fork_organization:
    description: 'The name of your organization which owns the vendor-json-repo fork used to create the PR from'
    required: true
  is_beta:
    description: "If true, this will be added to the years beta files"
    default: false
    required: false
    

runs:
  using: "composite"
  steps:
    - name: Clone fork
      uses: actions/checkout@v4
      with:
        repository: '${{ inputs.fork_organization }}/vendor-json-repo'
        fetch-depth: 0  # Fetch all history so we can use git diff
        path: "vendor-json-repo"
        # ref: "main"
        ref: "add_vendordep_action_private"
        
    - name: Checkout PR branch on fork
      shell: bash
      run: |
        git remote add upstream https://github.com/wpilibsuite/vendor-json-repo.git
      working-directory: vendor-json-repo

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Add vendordep
      shell: bash
      run: python add_vendordep.py --vendordep_file=$VENDORDEP_FILE --is_beta=$IS_BETA
      working-directory: vendor-json-repo
      env:
        VENDORDEP_FILE: ${{ inputs.vendordep_file }}
        IS_BETA: ${{ inputs.is_beta }}
        
    - name: Create XXX Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        path: vendor-json-repo
        base: main
        branch: ${{ inputs.pr_branch }} 
        token: ${{ inputs.token }}
        title:  ${{ inputs.pr_title }}
        
    # - name: CreateYYYY Pull Request
    #   uses: peter-evans/create-pull-request@v6
    #   with:
    #     push-to-fork: wpilibsuite/vendor-json-repo
    #     path: vendor-json-repo
    #     base: main
    #     branch: ${{ inputs.pr_branch }} 
    #     token: ${{ inputs.token }}
    #     title:  ${{ inputs.pr_title }}

    - name: Create PR
      shell: bash
      working-directory: "vendor-json-repo"
      run: gh pr create --repo wpilibsuite/vendor-json-repo --title "${{ inputs.pr_title }}" --body "Automated pull request" --base main --head ${{ inputs.fork_organization }}:${{ inputs.pr_branch }}

